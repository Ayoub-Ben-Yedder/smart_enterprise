<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Enterprise Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .control-button {
      width: 100%;
      padding: 12px;
      margin: 5px 0;
      background-color: #28a745;
      font-size: 16px;
    }
    
    .control-button:hover {
      background-color: #218838;
    }
    
    .off-button {
      background-color: #dc3545;
    }
    
    .off-button:hover {
      background-color: #c82333;
    }
    
    #sensorValue, #temperature, #humidity {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      color: #007bff;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Smart Enterprise Dashboard</h1>
    
    <div class="navigation">
      <a href="/" class="nav-button">Dashboard</a>
      <a href="/gallery" class="nav-button">Photo Gallery</a>
    </div>
    
    <div class="dashboard-grid">
      <div class="card">
        <h2>Door Control</h2>
        <button class="control-button" onclick="sendCommand('open_door')">Open Door</button>
        <button class="control-button off-button" onclick="sendCommand('close_door')">Close Door</button>
      </div>

      <div class="card">
        <h2>Lamp Control</h2>
        <button class="control-button" onclick="sendCommand('turn_on_lamp')">Turn On Lamp</button>
        <button class="control-button off-button" onclick="sendCommand('turn_off_lamp')">Turn Off Lamp</button>
      </div>

      <div class="card">
        <h2>Outlet Control</h2>
        <button class="control-button" onclick="sendCommand('turn_on_pris')">Turn On Outlet</button>
        <button class="control-button off-button" onclick="sendCommand('turn_off_pris')">Turn Off Outlet</button>
      </div>

      <div class="card">
        <h2>PIR sensor</h2>
        <div id="pir">Waiting for data...</div>
      </div>

      <div class="card">
        <h2>Connection Status</h2>
        <div id="connectionStatus" class="status disconnected">Disconnected</div>
        <button class="control-button" onclick="dashboard.initWebSocket()">Reconnect</button>
      </div>

      <div class="card">
        <h2>Temperature</h2>
        <div id="temperature">Waiting for data...</div>
      </div>
      
      <div class="card">
        <h2>Humidity</h2>
        <div id="humidity">Waiting for data...</div>
      </div>
    </div>
  </div>

  <script>
    class DashboardController {
      constructor() {
        this.gateway = 'ws://192.168.1.28/ws';
        this.websocket = null;
        this.init();
      }

      init() {
        this.initWebSocket();
      }

      initWebSocket() {
        console.log('Trying to open a WebSocket connection...');
        this.websocket = new WebSocket(this.gateway);
        this.websocket.onopen = (event) => this.onOpen(event);
        this.websocket.onclose = (event) => this.onClose(event);
        this.websocket.onmessage = (event) => this.onMessage(event);
      }

      onOpen(event) {
        console.log('Connection opened');
        this.updateConnectionStatus('Connected', 'connected');
      }

      onClose(event) {
        console.log('Connection closed');
        this.updateConnectionStatus('Disconnected', 'disconnected');
        setTimeout(() => this.initWebSocket(), 2000);
      }

      onMessage(event) {
        console.log('Received:', event.data);
        const data = event.data;
        
        if (data.startsWith('humidity:')) {
          document.getElementById('humidity').textContent = data.replace('humidity:', '') + " %";
        } else if (data.startsWith('temp:')) {
          document.getElementById('temperature').textContent = data.replace('temp:', '') + " Â°C";
        } else if (data.startsWith('pir:')) {
          document.getElementById('pir').textContent = data.replace('pir:', '') == '1' ? 'Motion Detected' : 'No Motion Detected';
        }
      }

      updateConnectionStatus(text, className) {
        const statusElement = document.getElementById('connectionStatus');
        statusElement.textContent = text;
        statusElement.className = `status ${className}`;
      }

      sendCommand(command) {
        if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
          console.log(`Sending command: ${command}`);
          this.websocket.send(command);
        } else {
          console.log('WebSocket not connected');
        }
      }
    }

    // Global instance and functions for backward compatibility
    let dashboard;
    
    window.addEventListener('load', () => {
      dashboard = new DashboardController();
    });

    function sendCommand(command) {
      if (dashboard) {
        dashboard.sendCommand(command);
      }
    }
  </script>
</body>
</html>